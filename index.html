<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì POST UTME CBT - University of Ibadan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Glitch Animation for Loading Page */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .glitch {
            animation: glitch 0.3s infinite;
        }
        /* Confetti Animation */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f00;
            animation: confetti 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col font-sans">
    <!-- Loading Page -->
    <div id="loadingPage" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <img src="https://files.catbox.moe/d15q3r.png" alt="App Logo" class="w-32 h-32 mb-4 glitch">
        <h1 class="text-4xl font-bold glitch">üéì POST UTME CBT - University of Ibadan</h1>
        <p class="text-lg mt-2">Loading Practice Platform...</p>
    </div>

    <!-- Main App Container (Hidden Initially) -->
    <div id="appContainer" class="hidden flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-gray-800 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold">üéì POST UTME CBT - University of Ibadan</h1>
            </div>
            <div id="profileSection" class="flex items-center space-x-4">
                <img id="profileAvatar" class="w-10 h-10 rounded-full object-cover" src="https://via.placeholder.com/40" alt="Profile Avatar">
                <span id="profileName" class="font-semibold"></span>
                <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700">Logout</button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="mainContent" class="flex-1 p-6">
            <!-- Login/Signup Modal -->
            <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
                <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
                    <h2 class="text-2xl font-bold mb-4">Login / Signup</h2>
                    <input id="nicknameInput" type="text" placeholder="Enter your nickname" class="w-full p-2 mb-4 bg-gray-700 rounded text-white">
                    <input id="avatarInput" type="file" accept="image/*" class="w-full p-2 mb-4 bg-gray-700 rounded text-white">
                    <img id="avatarPreview" class="w-20 h-20 rounded-full object-cover mb-4 mx-auto" src="https://via.placeholder.com/40" alt="Avatar Preview">
                    <button id="authBtn" class="w-full bg-blue-600 p-2 rounded hover:bg-blue-700">Continue</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Welcome, <span id="welcomeName"></span>!</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="English"><span>üìö</span><span>English</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Mathematics"><span>üßÆ</span><span>Mathematics</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Biology"><span>üß¨</span><span>Biology</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Physics"><span>‚ö°Ô∏è</span><span>Physics</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Chemistry"><span>üß™</span><span>Chemistry</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Economics"><span>üí∞</span><span>Economics</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Government"><span>üèõÔ∏è</span><span>Government</span></button>
                    <button class="subject-btn bg-blue-600 p-4 rounded hover:bg-blue-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Literature"><span>üìñ</span><span>Literature</span></button>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4">üìö Study Plans</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="English"><span>üìñ</span><span>English Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Mathematics"><span>üìê</span><span>Mathematics Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Biology"><span>üî¨</span><span>Biology Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Physics"><span>‚öõÔ∏è</span><span>Physics Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Chemistry"><span>‚öóÔ∏è</span><span>Chemistry Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Economics"><span>üìä</span><span>Economics Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Government"><span>üèõÔ∏è</span><span>Government Study Plan</span></button>
                        <button class="study-plan-btn bg-purple-600 p-4 rounded hover:bg-purple-700 transition transform hover:scale-105 flex items-center space-x-2" data-subject="Literature"><span>üìö</span><span>Literature Study Plan</span></button>
                    </div>
                </div>
                <button id="showLeaderboard" class="mt-6 bg-green-600 px-4 py-2 rounded hover:bg-green-700">View Leaderboard</button>
            </div>

            <!-- Quiz Section -->
            <div id="quizSection" class="hidden">
                <div class="flex justify-between mb-4">
                    <span id="questionCounter" class="text-lg font-semibold"></span>
                    <span id="timerDisplay" class="text-lg font-semibold bg-red-600 px-4 py-2 rounded"></span>
                </div>
                <div class="w-full bg-gray-800 rounded h-2 mb-4">
                    <div id="progressFill" class="bg-blue-600 h-full rounded"></div>
                </div>
                <img id="questionImage" class="max-w-full h-auto mb-4 hidden" alt="Question Image">
                <p id="questionText" class="text-xl mb-4"></p>
                <div id="optionsContainer" class="grid grid-cols-1 gap-4"></div>
                <div class="flex justify-between mt-6">
                    <button id="prevBtn" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Previous</button>
                    <button id="submitBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700" disabled>Submit</button>
                    <button id="nextBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 hidden">Next</button>
                </div>
                <div id="explanationContainer" class="mt-6 bg-gray-800 p-4 rounded hidden">
                    <p id="explanationText" class="text-sm whitespace-pre-wrap"></p>
                    <button id="toggleAI" class="mt-4 bg-green-600 px-4 py-2 rounded hover:bg-green-700">Switch to GPT</button>
                </div>
            </div>

            <!-- Review Mode -->
            <div id="reviewSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Review Your Answers</h2>
                <div id="reviewContent"></div>
                <button id="backToDashboard" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 mt-4">Back to Dashboard</button>
                <button id="retryQuiz" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 mt-4 ml-4">Retry Quiz</button>
            </div>

            <!-- Study Plan Section -->
            <div id="studyPlanSection" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">üìö Study Plan - <span id="studySubjectTitle"></span></h2>
                    <button id="backToDashboardStudy" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">‚Üê Back to Dashboard</button>
                </div>
                <!-- Topic Selection -->
                <div id="topicSelection" class="mb-6">
                    <h3 class="text-xl font-bold mb-4">Select a Topic to Study:</h3>
                    <div id="topicsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
                <!-- Study Content -->
                <div id="studyContent" class="hidden">
                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold" id="currentTopicTitle"></h3>
                            <div class="flex space-x-2">
                                <button id="regenerateStudyPlan" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">üîÑ Regenerate</button>
                                <button id="toggleStudyPlanAI" class="bg-yellow-600 px-4 py-2 rounded hover:bg-yellow-700">Switch to Static</button>
                                <button id="startTopicQuiz" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">üìù Take Quiz</button>
                            </div>
                        </div>
                        <!-- Study Plan Content -->
                        <div id="studyPlanContent" class="prose prose-invert max-w-none">
                            <div class="flex items-center justify-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                                <span class="ml-2">Generating comprehensive study plan...</span>
                            </div>
                        </div>
                        <!-- Study Progress -->
                        <div class="mt-6 p-4 bg-gray-700 rounded">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Study Progress</span>
                                <span id="studyProgress">0%</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div id="studyProgressBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <button id="markAsStudied" class="mt-4 bg-green-600 px-4 py-2 rounded hover:bg-green-700 w-full">‚úì Mark Topic as Studied</button>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="backToTopics" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">‚Üê Back to Topics</button>
                        <button id="goToStudy" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">üìö Go to Study</button>
                    </div>
                </div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboardSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
                <div class="bg-gray-800 p-4 rounded">
                    <div class="flex justify-between py-2 border-b border-gray-700">
                        <span>1. User1</span><span>95%</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-700">
                        <span>2. User2</span><span>90%</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span>3. User3</span><span>85%</span>
                    </div>
                </div>
                <button id="backToDashboardLeaderboard" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 mt-4">Back to Dashboard</button>
            </div>
        </main>

        <!-- Confetti Container -->
        <div id="confettiContainer" class="fixed inset-0 pointer-events-none"></div>
    </div>

    <script>
        class QuizApp {
            constructor() {
                this.currentSubject = null;
                this.currentQuestion = null;
                this.currentQuestionIndex = 0;
                this.totalQuestions = 10;
                this.score = 0;
                this.timeRemaining = 30;
                this.selectedAnswer = null;
                this.sessionData = [];
                this.timer = null;
                this.useGemini = false; // Default to GPT (false means use GPT or static)
                this.currentTopic = null;
                this.currentStudySubject = null;
                this.studiedTopics = JSON.parse(localStorage.getItem('studiedTopics') || '{}');
                this.isTopicBasedQuiz = false;
                this.currentTopicContext = null;

                // DOM Elements
                this.loadingPage = document.getElementById('loadingPage');
                this.appContainer = document.getElementById('appContainer');
                this.authModal = document.getElementById('authModal');
                this.profileAvatar = document.getElementById('profileAvatar');
                this.profileName = document.getElementById('profileName');
                this.nicknameInput = document.getElementById('nicknameInput');
                this.avatarInput = document.getElementById('avatarInput');
                this.avatarPreview = document.getElementById('avatarPreview');
                this.authBtn = document.getElementById('authBtn');
                this.dashboard = document.getElementById('dashboard');
                this.welcomeName = document.getElementById('welcomeName');
                this.quizSection = document.getElementById('quizSection');
                this.questionCounter = document.getElementById('questionCounter');
                this.timerDisplay = document.getElementById('timerDisplay');
                this.progressFill = document.getElementById('progressFill');
                this.questionImage = document.getElementById('questionImage');
                this.questionText = document.getElementById('questionText');
                this.optionsContainer = document.getElementById('optionsContainer');
                this.prevBtn = document.getElementById('prevBtn');
                this.submitBtn = document.getElementById('submitBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.explanationContainer = document.getElementById('explanationContainer');
                this.explanationText = document.getElementById('explanationText');
                this.toggleAI = document.getElementById('toggleAI');
                this.reviewSection = document.getElementById('reviewSection');
                this.reviewContent = document.getElementById('reviewContent');
                this.backToDashboard = document.getElementById('backToDashboard');
                this.retryQuiz = document.getElementById('retryQuiz');
                this.leaderboardSection = document.getElementById('leaderboardSection');
                this.backToDashboardLeaderboard = document.getElementById('backToDashboardLeaderboard');
                this.showLeaderboard = document.getElementById('showLeaderboard');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.studyPlanSection = document.getElementById('studyPlanSection');
                this.studySubjectTitle = document.getElementById('studySubjectTitle');
                this.topicSelection = document.getElementById('topicSelection');
                this.topicsContainer = document.getElementById('topicsContainer');
                this.studyContent = document.getElementById('studyContent');
                this.currentTopicTitle = document.getElementById('currentTopicTitle');
                this.studyPlanContent = document.getElementById('studyPlanContent');
                this.studyProgress = document.getElementById('studyProgress');
                this.studyProgressBar = document.getElementById('studyProgressBar');
                this.backToDashboardStudy = document.getElementById('backToDashboardStudy');
                this.backToTopics = document.getElementById('backToTopics');
                this.goToStudy = document.getElementById('goToStudy');
                this.regenerateStudyPlan = document.getElementById('regenerateStudyPlan');
                this.toggleStudyPlanAI = document.getElementById('toggleStudyPlanAI');
                this.startTopicQuiz = document.getElementById('startTopicQuiz');
                this.markAsStudied = document.getElementById('markAsStudied');

                // Event Listeners
                this.authBtn.addEventListener('click', () => this.handleAuth());
                this.avatarInput.addEventListener('change', () => this.previewAvatar());
                this.prevBtn.addEventListener('click', () => this.prevQuestion());
                this.submitBtn.addEventListener('click', () => this.submitAnswer());
                this.nextBtn.addEventListener('click', () => this.nextQuestion());
                this.toggleAI.addEventListener('click', () => this.toggleAIExplanation());
                this.backToDashboard.addEventListener('click', () => this.showDashboard());
                this.retryQuiz.addEventListener('click', () => this.startQuiz(this.currentSubject));
                this.backToDashboardLeaderboard.addEventListener('click', () => this.showDashboard());
                this.showLeaderboard.addEventListener('click', () => this.showLeaderboardSection());
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.backToDashboardStudy.addEventListener('click', () => this.showDashboard());
                this.backToTopics.addEventListener('click', () => this.showTopicSelection());
                this.goToStudy.addEventListener('click', () => this.showTopicSelection());
                this.regenerateStudyPlan.addEventListener('click', () => this.generateStudyPlan(this.currentTopic));
                this.toggleStudyPlanAI.addEventListener('click', () => this.toggleStudyPlanAI());
                this.startTopicQuiz.addEventListener('click', () => this.startTopicBasedQuiz());
                this.markAsStudied.addEventListener('click', () => this.markTopicAsStudied());
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.startQuiz(btn.dataset.subject));
                });
                document.querySelectorAll('.study-plan-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.showStudyPlan(btn.dataset.subject));
                });

                // Initialize
                this.init();
            }

            init() {
                console.log('Initializing app...');
                try {
                    setTimeout(() => {
                        console.log('Hiding loading page...');
                        this.loadingPage.classList.add('hidden');
                        this.appContainer.classList.remove('hidden');
                        const profile = JSON.parse(localStorage.getItem('profile') || '{}');
                        if (profile && profile.nickname) {
                            console.log('Profile found:', profile.nickname);
                            this.profileName.textContent = profile.nickname;
                            this.welcomeName.textContent = profile.nickname;
                            this.profileAvatar.src = profile.avatar || 'https://via.placeholder.com/40';
                            this.showDashboard();
                        } else {
                            console.log('No profile found, showing auth modal...');
                            this.authModal.classList.remove('hidden');
                        }
                    }, 2000);
                } catch (error) {
                    console.error('Error during initialization:', error);
                    alert('Failed to initialize the app. Please refresh the page.');
                }
            }

            handleAuth() {
                const nickname = this.nicknameInput.value.trim();
                if (!nickname) {
                    alert('Please enter a nickname');
                    return;
                }
                const avatar = this.avatarPreview.src;
                const profile = { nickname, avatar };
                localStorage.setItem('profile', JSON.stringify(profile));
                this.profileName.textContent = nickname;
                this.welcomeName.textContent = nickname;
                this.profileAvatar.src = avatar;
                this.authModal.classList.add('hidden');
                this.showDashboard();
            }

            previewAvatar() {
                const file = this.avatarInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        this.avatarPreview.src = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            logout() {
                localStorage.removeItem('profile');
                this.authModal.classList.remove('hidden');
                this.dashboard.classList.add('hidden');
                this.quizSection.classList.add('hidden');
                this.leaderboardSection.classList.add('hidden');
                this.studyPlanSection.classList.add('hidden');
                this.nicknameInput.value = '';
                this.avatarPreview.src = 'https://via.placeholder.com/40';
            }

            showDashboard() {
                this.dashboard.classList.remove('hidden');
                this.quizSection.classList.add('hidden');
                this.reviewSection.classList.add('hidden');
                this.leaderboardSection.classList.add('hidden');
                this.studyPlanSection.classList.add('hidden');
            }

            showLeaderboardSection() {
                this.dashboard.classList.add('hidden');
                this.leaderboardSection.classList.remove('hidden');
                this.studyPlanSection.classList.add('hidden');
            }

            async startQuiz(subject) {
                this.currentSubject = subject;
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.sessionData = [];
                this.isTopicBasedQuiz = false;
                this.currentTopicContext = null;
                this.dashboard.classList.add('hidden');
                this.quizSection.classList.remove('hidden');
                this.loadingPage.classList.remove('hidden');
                await this.loadQuestion();
                this.loadingPage.classList.add('hidden');
            }

            async loadQuestion() {
                try {
                    let url = `https://questions.aloc.com.ng/api/v2/q?subject=${this.currentSubject}`;
                    if (this.isTopicBasedQuiz && this.currentTopicContext) {
                        url += `&topic=${encodeURIComponent(this.currentTopicContext)}`;
                    }
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'AccessToken': 'QB-139d5195a490b3c12794'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch question');
                    }

                    const data = await response.json();
                    this.currentQuestion = data.data;
                    console.log('Loaded question:', this.currentQuestion);
                    this.displayQuestion();
                    this.startTimer();
                } catch (error) {
                    console.error('Error loading question:', error);
                    alert('Failed to load question. Please try again.');
                    this.showDashboard();
                }
            }

            displayQuestion() {
                this.questionCounter.textContent = `Question ${this.currentQuestionIndex + 1} of ${this.totalQuestions}`;
                this.questionText.textContent = this.currentQuestion.question || 'Question text not available';

                const progress = ((this.currentQuestionIndex) / this.totalQuestions) * 100;
                this.progressFill.style.width = `${progress}%`;

                if (this.currentQuestion.image) {
                    this.questionImage.src = this.currentQuestion.image;
                    this.questionImage.classList.remove('hidden');
                } else {
                    this.questionImage.classList.add('hidden');
                }

                this.selectedAnswer = null;
                this.submitBtn.disabled = true;
                this.submitBtn.classList.remove('hidden');
                this.nextBtn.classList.add('hidden');
                this.explanationContainer.classList.add('hidden');

                this.optionsContainer.innerHTML = '';
                this.displayOptions();
            }

            displayOptions() {
                const options = ['a', 'b', 'c', 'd'];
                this.optionsContainer.innerHTML = '';

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button bg-gray-700 p-4 rounded hover:bg-gray-600 w-full text-left';
                    button.dataset.option = option.toUpperCase();
                    button.innerHTML = `
                        <span class="font-bold">${option.toUpperCase()}</span>
                        ${this.currentQuestion.option[option] || 'Option not available'}
                    `;
                    button.addEventListener('click', () => this.selectOption(option.toUpperCase(), button));
                    this.optionsContainer.appendChild(button);
                });
            }

            selectOption(option, buttonElement) {
                console.log('Option clicked:', option);
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('bg-blue-600');
                });
                buttonElement.classList.add('bg-blue-600');
                this.selectedAnswer = option;
                this.submitBtn.disabled = false;
            }

            startTimer() {
                this.timeRemaining = 30;
                this.updateTimerDisplay();
                this.timer = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    if (this.timeRemaining <= 0) {
                        this.timeUp();
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                this.timerDisplay.style.background = this.timeRemaining <= 10 ? '#e74c3c' : '#ff6b6b';
            }

            timeUp() {
                clearInterval(this.timer);
                if (this.selectedAnswer) {
                    this.submitAnswer();
                } else {
                    this.showCorrectAnswer();
                    this.nextQuestion();
                }
            }

            async submitAnswer() {
                clearInterval(this.timer);
                const isCorrect = this.selectedAnswer === this.currentQuestion.answer;
                if (isCorrect) {
                    this.score++;
                }

                this.sessionData.push({
                    question: this.currentQuestion,
                    userAnswer: this.selectedAnswer,
                    correct: isCorrect,
                    timeSpent: 30 - this.timeRemaining
                });

                this.showCorrectAnswer();
                await this.showExplanation();
                this.nextBtn.classList.remove('hidden');
                this.submitBtn.classList.add('hidden');
            }

            showCorrectAnswer() {
                document.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.dataset.option === this.currentQuestion.answer) {
                        btn.classList.add('bg-green-600');
                    } else if (btn.dataset.option === this.selectedAnswer && !this.sessionData[this.currentQuestionIndex].correct) {
                        btn.classList.add('bg-red-600');
                    }
                });
            }

            cleanAIResponse(text) {
                return text
                    .replace(/\*\*|\*|_|\#\#/g, '')
                    .replace(/\n\s*\n/g, '\n')
                    .replace(/^\s+|\s+$/g, '')
                    .replace(/```/g, '');
            }

            async showExplanation() {
                try {
                    this.explanationText.textContent = 'Generating AI explanation...';
                    this.explanationContainer.classList.remove('hidden');

                    const prompt = `You are an expert tutor for the University of Ibadan POST UTME CBT. Provide a detailed, educational explanation for the following ${this.currentSubject} question, suitable for a student preparing for the exam. Include why the correct answer is right, why other options are incorrect, and address common misconceptions. Keep the tone clear, concise, and engaging. Do not use markdown formatting (e.g., **, *, #) in your response.

Question: "${this.currentQuestion.question}"
Options:
A) ${this.currentQuestion.option.a || 'N/A'}
B) ${this.currentQuestion.option.b || 'N/A'}
C) ${this.currentQuestion.option.c || 'N/A'}
D) ${this.currentQuestion.option.d || 'N/A'}
Correct Answer: ${this.currentQuestion.answer}
Student's Answer: ${this.selectedAnswer || 'No answer selected'}

Explanation should be 150-300 words, structured with an introduction, explanation of the correct answer, analysis of incorrect options, and a summary of key takeaways. After the explanation, explicitly state: "Correct Answer: [answer]".`;

                    let response;
                    if (this.useGemini) {
                        response = await fetch(`https://kaiz-apis.gleeze.com/api/gpt-4.1?ask=${encodeURIComponent(prompt)}&uid=1268&apikey=a0ebe80e-bf1a-4dbf-8d36-6935b1bfa5ea`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (!response.ok) throw new Error('GPT API failed');
                        const data = await response.json();
                        const rawText = data.response || 'No explanation provided by GPT API.';
                        this.explanationText.textContent = this.cleanAIResponse(rawText) + `\n\nCorrect Answer: ${this.currentQuestion.answer}`;
                    } else {
                        response = await fetch(`https://kaiz-apis.gleeze.com/api/gpt-4.1?ask=${encodeURIComponent(prompt)}&uid=1268&apikey=a0ebe80e-bf1a-4dbf-8d36-6935b1bfa5ea`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (!response.ok) throw new Error('GPT API failed');
                        const data = await response.json();
                        const rawText = data.response || 'No explanation provided by GPT API.';
                        this.explanationText.textContent = this.cleanAIResponse(rawText) + `\n\nCorrect Answer: ${this.currentQuestion.answer}`;
                    }
                } catch (error) {
                    console.error('Error getting explanation:', error);
                    this.explanationText.textContent = `Explanation: The correct answer is based on key concepts in ${this.currentSubject}. Please review your study materials for a detailed understanding of this topic.\n\nCorrect Answer: ${this.currentQuestion.answer}`;
                }
            }

            toggleAIExplanation() {
                this.useGemini = !this.useGemini;
                this.toggleAI.textContent = `Switch to ${this.useGemini ? 'Static' : 'GPT'}`;
                this.showExplanation();
            }

            prevQuestion() {
                if (this.currentQuestionIndex > 0) {
                    clearInterval(this.timer);
                    this.currentQuestionIndex--;
                    this.loadQuestion();
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.totalQuestions) {
                    clearInterval(this.timer);
                    this.submitBtn.classList.remove('hidden');
                    this.nextBtn.classList.add('hidden');
                    this.loadQuestion();
                } else {
                    this.endQuiz();
                }
            }

            endQuiz() {
                this.quizSection.classList.add('hidden');
                this.reviewSection.classList.remove('hidden');
                this.showReview();
                this.showConfetti();
                localStorage.setItem('quizResults', JSON.stringify(this.sessionData));
            }

            showReview() {
                this.reviewContent.innerHTML = '';
                this.sessionData.forEach((data, index) => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-4 rounded mb-4';
                    div.innerHTML = `
                        <p class="font-bold">Question ${index + 1}: ${data.question.question}</p>
                        <p>Your Answer: ${data.userAnswer || 'No answer'}</p>
                        <p>Correct Answer: ${data.question.answer}</p>
                        <p>Status: ${data.correct ? 'Correct' : 'Incorrect'}</p>
                        <p>Time Spent: ${data.timeSpent}s</p>
                    `;
                    this.reviewContent.appendChild(div);
                });
            }

            showConfetti() {
                const confettiContainer = document.getElementById('confettiContainer');
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.background = ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    confettiContainer.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            getSubjectTopics(subject) {
                const topics = {
                    'English': [
                        'Comprehension Passages', 'Grammar and Syntax', 'Vocabulary and Word Formation',
                        'Figures of Speech', 'Essay Writing', 'Oral English', 'Literature Appreciation',
                        'Phonetics and Phonology', 'Sentence Construction', 'Punctuation and Spelling'
                    ],
                    'Mathematics': [
                        'Algebra and Polynomials', 'Coordinate Geometry', 'Trigonometry', 'Calculus Basics',
                        'Statistics and Probability', 'Set Theory', 'Number Theory', 'Logarithms and Indices',
                        'Quadratic Equations', 'Sequences and Series', 'Geometry and Mensuration'
                    ],
                    'Biology': [
                        'Cell Biology', 'Genetics and Heredity', 'Ecology and Environment', 'Plant Biology',
                        'Animal Biology', 'Human Physiology', 'Evolution', 'Reproduction',
                        'Nutrition and Respiration', 'Classification of Living Things', 'Biotechnology'
                    ],
                    'Physics': [
                        'Mechanics and Motion', 'Waves and Oscillations', 'Electricity and Magnetism',
                        'Thermodynamics', 'Optics', 'Atomic Physics', 'Nuclear Physics',
                        'Electromagnetism', 'Simple Harmonic Motion', 'Modern Physics'
                    ],
                    'Chemistry': [
                        'Atomic Structure', 'Chemical Bonding', 'Periodic Table', 'Acids and Bases',
                        'Organic Chemistry', 'Electrochemistry', 'Chemical Kinetics', 'Equilibrium',
                        'Thermochemistry', 'Solutions and Colligative Properties', 'Redox Reactions'
                    ],
                    'Economics': [
                        'Microeconomics', 'Macroeconomics', 'Market Structures', 'Demand and Supply',
                        'National Income', 'Money and Banking', 'International Trade', 'Public Finance',
                        'Economic Development', 'Inflation and Unemployment', 'Economic Systems'
                    ],
                    'Government': [
                        'Constitutional Law', 'Political Systems', 'Democracy and Governance', 'Federalism',
                        'Human Rights', 'International Relations', 'Political Parties', 'Elections',
                        'Rule of Law', 'Separation of Powers', 'Nigerian Government'
                    ],
                    'Literature': [
                        'Poetry Analysis', 'Prose and Fiction', 'Drama and Theatre', 'Literary Devices',
                        'African Literature', 'Oral Literature', 'Literary Criticism', 'Themes and Motifs',
                        'Character Analysis', 'Plot and Setting', 'Comparative Literature'
                    ]
                };
                return topics[subject] || [];
            }

            showStudyPlan(subject) {
                this.currentStudySubject = subject;
                this.studySubjectTitle.textContent = subject;
                this.dashboard.classList.add('hidden');
                this.quizSection.classList.add('hidden');
                this.reviewSection.classList.add('hidden');
                this.leaderboardSection.classList.add('hidden');
                this.studyPlanSection.classList.remove('hidden');
                this.showTopicSelection();
            }

            showTopicSelection() {
                this.topicSelection.classList.remove('hidden');
                this.studyContent.classList.add('hidden');
                this.loadTopics();
            }

            loadTopics() {
                this.topicsContainer.innerHTML = '';
                const topics = this.getSubjectTopics(this.currentStudySubject);
                
                topics.forEach(topic => {
                    const button = document.createElement('button');
                    const isStudied = this.studiedTopics[this.currentStudySubject]?.includes(topic);
                    button.className = `topic-btn p-4 rounded transition transform hover:scale-105 ${
                        isStudied ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700'
                    }`;
                    button.innerHTML = `
                        <div class="text-left">
                            <div class="font-semibold">${topic}</div>
                            <div class="text-sm opacity-75">${isStudied ? '‚úì Studied' : 'Click to study'}</div>
                        </div>
                    `;
                    button.addEventListener('click', () => this.selectTopic(topic));
                    this.topicsContainer.appendChild(button);
                });
            }

            selectTopic(topic) {
                this.currentTopic = topic;
                this.currentTopicTitle.textContent = topic;
                this.topicSelection.classList.add('hidden');
                this.studyContent.classList.remove('hidden');
                this.toggleStudyPlanAI.textContent = `Switch to ${this.useGemini ? 'Static' : 'GPT'}`;
                this.generateStudyPlan(topic);
                this.updateStudyProgress();
            }

            async generateStudyPlan(topic, retryCount = 0, maxRetries = 2) {
                this.studyPlanContent.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                        <span class="ml-2">Generating comprehensive study plan for ${topic} using ${this.useGemini ? 'Static Content' : 'GPT'}...</span>
                    </div>
                `;

                try {
                    console.log(`Attempting to generate study plan for ${topic} using ${this.useGemini ? 'Static Content' : 'GPT'} (Attempt ${retryCount + 1}/${maxRetries + 1})`);
                    let studyPlan;

                    if (!this.useGemini) {
                        const prompt = `You are an expert tutor for the University of Ibadan POST UTME examination. Create a comprehensive, textbook-style study guide for the topic "${topic}" in ${this.currentStudySubject}, designed to prepare students for the POST UTME. The content should be self-contained, covering everything a student needs to know, similar to a textbook chapter. Use clear, educational language and avoid markdown formatting (e.g., **, *, #).

Structure the response as follows:
1. INTRODUCTION: Explain the topic's importance in the POST UTME and its relevance to ${this.currentStudySubject}.
2. DEFINITIONS: Provide clear definitions of 5-7 key terms related to the topic, with examples.
3. CORE CONCEPTS: Explain 5-7 main concepts in detail, including formulas, principles, or rules where applicable.
4. DETAILED EXPLANATIONS: Break down the topic into subtopics with in-depth explanations, including step-by-step processes or examples.
5. POST UTME EXAM TIPS: Describe how this topic is tested in the University of Ibadan POST UTME, including common question types and strategies.
6. PRACTICE QUESTIONS: Provide 3-5 sample POST UTME-style questions with answers (no explanations needed).
7. SUMMARY: Summarize the key points for quick revision.

The content should be 600-800 words, engaging, and tailored to the University of Ibadan POST UTME standards. Use headings and bullet points for clarity.`;

                        const response = await fetch(`https://kaiz-apis.gleeze.com/api/gpt-4.1?ask=${encodeURIComponent(prompt)}&uid=1268&apikey=a0ebe80e-bf1a-4dbf-8d36-6935b1bfa5ea`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`GPT API failed - HTTP ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        studyPlan = data.response || 'No study plan provided by GPT API.';
                    } else {
                        studyPlan = this.getFallbackStudyPlan(this.currentStudySubject, topic);
                    }

                    console.log('Study plan generated successfully:', studyPlan.substring(0, 100) + '...');

                    this.studyPlanContent.innerHTML = `
                        <div class="prose prose-invert max-w-none">
                            <div class="whitespace-pre-line leading-relaxed text-gray-100">
                                ${this.formatStudyPlan(studyPlan)}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Error generating study plan with ${this.useGemini ? 'Static Content' : 'GPT'} (Attempt ${retryCount + 1}):`, error);

                    if (!this.useGemini && retryCount < maxRetries) {
                        console.log(`Retrying with GPT... (${retryCount + 1}/${maxRetries})`);
                        setTimeout(() => this.generateStudyPlan(topic, retryCount + 1, maxRetries), 1000);
                        return;
                    }

                    console.warn('Max retries reached or static mode, falling back to static content.');
                    const fallbackPlan = this.getFallbackStudyPlan(this.currentStudySubject, topic);
                    this.studyPlanContent.innerHTML = `
                        <div class="prose prose-invert max-w-none">
                            <div class="whitespace-pre-line leading-relaxed text-gray-100">
                                ${this.formatStudyPlan(fallbackPlan)}
                            </div>
                            <div class="text-yellow-400 p-4 bg-yellow-900/20 rounded mt-4">
                                <h3 class="font-bold mb-2">Note</h3>
                                <p>This is a fallback study plan due to an issue with the ${this.useGemini ? 'static content' : 'GPT API'}. Please try again later or switch to static content.</p>
                                <button onclick="app.generateStudyPlan('${topic}')" class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Retry ${this.useGemini ? 'Static' : 'GPT'}</button>
                            </div>
                        </div>
                    `;
                }
            }

            toggleStudyPlanAI() {
                this.useGemini = !this.useGemini;
                this.toggleStudyPlanAI.textContent = `Switch to ${this.useGemini ? 'Static' : 'GPT'}`;
                console.log(`Switched study plan source to ${this.useGemini ? 'Static' : 'GPT'}`);
                this.generateStudyPlan(this.currentTopic);
            }

            getFallbackStudyPlan(subject, topic) {
                const specificPlans = {
                    'English': {
                        'Comprehension Passages': `
INTRODUCTION
Comprehension Passages are a cornerstone of the English POST UTME, testing your ability to understand, interpret, and analyze written texts. Mastering this topic is crucial for scoring high in the University of Ibadan POST UTME.

DEFINITIONS
- Main Idea: The central theme or primary message of a passage. Example: A passage about climate change may have the main idea that human activity contributes to global warming.
- Vocabulary in Context: Determining a word's meaning based on its use in a sentence. Example: "The politician was candid" implies honesty.
- Inference: A conclusion drawn from evidence not explicitly stated. Example: If a character is described as shivering, you infer it's cold.
- Supporting Details: Facts or examples that reinforce the main idea. Example: Statistics in a passage about deforestation.
- Tone: The author's attitude toward the subject. Example: A sarcastic tone mocks the subject.

CORE CONCEPTS
- Identifying the Main Idea: Skim the passage to grasp its purpose.
- Understanding Vocabulary: Use context clues to decode unfamiliar words.
- Making Inferences: Combine clues from the text with prior knowledge.
- Locating Supporting Details: Find evidence that backs the main point.
- Determining Tone and Purpose: Analyze word choice to understand the author's intent.

DETAILED EXPLANATIONS
1. Reading Strategy: Read the questions first to focus your reading. Skim the passage, then read closely for details.
2. Vocabulary Skills: Practice synonyms and antonyms. Use surrounding sentences to infer meanings.
3. Inference Questions: Look for implied ideas. Example: "She avoided eye contact" suggests nervousness.
4. Supporting Details: Highlight facts, examples, or statistics in the passage.
5. Tone Analysis: Note positive, negative, or neutral words to identify tone.

POST UTME EXAM TIPS
Comprehension questions (5-10 per passage) test main ideas, vocabulary, inferences, and tone. Expect passages on science, culture, or history. Time management is key: allocate 5-7 minutes per passage.

PRACTICE QUESTIONS
1. What is the main idea of a passage discussing solar energy benefits? A) Solar energy is expensive B) Solar energy is renewable C) Solar energy is unreliable D) Solar energy is outdated. Answer: B
2. In the sentence "The policy was futile," futile means: A) Effective B) Useless C) Popular D) Complex. Answer: B
3. A passage states, "He smiled despite the loss." What can be inferred? A) He was unaffected B) He was angry C) He was optimistic D) He was confused. Answer: C

SUMMARY
- Focus on main ideas, vocabulary, and inferences.
- Practice time management with passages.
- Use context clues and evidence to answer questions.
                        `
                    }
                };
                return specificPlans[subject]?.[topic] || `
INTRODUCTION
The topic "${topic}" is a critical component of ${subject} in the University of Ibadan POST UTME, forming the foundation for key concepts tested in the exam.

DEFINITIONS
- Term 1: Basic principle of ${topic}. Example: A fundamental rule or definition.
- Term 2: Common pattern in ${topic}. Example: A typical scenario.
- Term 3: Key terminology. Example: A core word or phrase.
- Term 4: Application of ${topic}. Example: A practical use.
- Term 5: Related concept. Example: A connected idea.

CORE CONCEPTS
- Concept 1: Understand the principles of ${topic}.
- Concept 2: Identify patterns and applications.
- Concept 3: Master problem-solving techniques.
- Concept 4: Learn key terms and definitions.
- Concept 5: Explore real-world examples.

DETAILED EXPLANATIONS
Start by reviewing the fundamentals of ${topic}. Practice with examples to understand the 'why' behind each concept.

POST UTME EXAM TIPS
The University of Ibadan tests ${topic} through multiple-choice questions requiring theoretical and practical knowledge.

PRACTICE QUESTIONS
1. What is a key aspect of ${topic}? A) Option 1 B) Option 2 C) Option 3 D) Option 4. Answer: C
2. Define a term in ${topic}: A) Definition 1 B) Definition 2 C) Definition 3 D) Definition 4. Answer: B
3. Apply ${topic}: A) Application 1 B) Application 2 C) Application 3 D) Application 4. Answer: A

SUMMARY
- ${topic} is foundational for ${subject}.
- Focus on definitions and core concepts.
- Practice regularly to master exam questions.
                `;
            }

            formatStudyPlan(text) {
                return text
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/###\s*([^\n]+)/g, '<h3 class="text-xl font-bold mt-6 mb-3 text-blue-300">$1</h3>')
                    .replace(/##\s*([^\n]+)/g, '<h2 class="text-2xl font-bold mt-8 mb-4 text-green-300">$1</h2>')
                    .replace(/^\d+\.\s*([^\n]+)/gm, '<div class="mt-4 mb-2"><strong class="text-yellow-300">$1</strong></div>')
                    .replace(/^[-‚Ä¢]\s*([^\n]+)/gm, '<div class="ml-4 mb-1">‚Ä¢ $1</div>')
                    .replace(/\n\n/g, '<div class="mb-4"></div>');
            }

            updateStudyProgress() {
                if (!this.studiedTopics[this.currentStudySubject]) {
                    this.studiedTopics[this.currentStudySubject] = [];
                }
                
                const totalTopics = this.getSubjectTopics(this.currentStudySubject).length;
                const studiedCount = this.studiedTopics[this.currentStudySubject].length;
                const percentage = Math.round((studiedCount / totalTopics) * 100);
                
                this.studyProgress.textContent = `${percentage}%`;
                this.studyProgressBar.style.width = `${percentage}%`;
            }

            markTopicAsStudied() {
                if (!this.studiedTopics[this.currentStudySubject]) {
                    this.studiedTopics[this.currentStudySubject] = [];
                }
                
                if (!this.studiedTopics[this.currentStudySubject].includes(this.currentTopic)) {
                    this.studiedTopics[this.currentStudySubject].push(this.currentTopic);
                    localStorage.setItem('studiedTopics', JSON.stringify(this.studiedTopics));
                    this.updateStudyProgress();
                    
                    const button = this.markAsStudied;
                    const originalText = button.textContent;
                    button.textContent = '‚úì Marked as Studied!';
                    button.classList.add('bg-green-700');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-700');
                    }, 2000);
                }
            }

            async startTopicBasedQuiz() {
                this.currentSubject = this.currentStudySubject;
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.sessionData = [];
                this.totalQuestions = 5;
                this.isTopicBasedQuiz = true;
                this.currentTopicContext = this.currentTopic;
                
                this.studyPlanSection.classList.add('hidden');
                this.quizSection.classList.remove('hidden');
                this.loadingPage.classList.remove('hidden');
                
                await this.loadQuestion();
                this.loadingPage.classList.add('hidden');
            }
        }

        // Initialize the app
        const app = new QuizApp();
    </script>
</body>
</html>
